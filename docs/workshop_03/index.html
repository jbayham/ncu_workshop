<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jude Bayham">

<title>Workshop 03: Processing and Analyzing Raster Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">Prerequisites</a>
  <ul class="collapse">
  <li><a href="#reading" id="toc-reading" class="nav-link" data-scroll-target="#reading">Reading</a></li>
  <li><a href="#digital-elevation-model-dem" id="toc-digital-elevation-model-dem" class="nav-link" data-scroll-target="#digital-elevation-model-dem">Digital Elevation Model (DEM)</a></li>
  <li><a href="#rstudio" id="toc-rstudio" class="nav-link" data-scroll-target="#rstudio">RStudio</a></li>
  </ul></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a></li>
  <li><a href="#raster-aggregation-and-zonal-statistics" id="toc-raster-aggregation-and-zonal-statistics" class="nav-link" data-scroll-target="#raster-aggregation-and-zonal-statistics">Raster Aggregation and Zonal Statistics</a>
  <ul class="collapse">
  <li><a href="#step-1-loading-and-preparing-raster-data" id="toc-step-1-loading-and-preparing-raster-data" class="nav-link" data-scroll-target="#step-1-loading-and-preparing-raster-data">Step 1: Loading and Preparing Raster Data</a></li>
  <li><a href="#step-2-resampling" id="toc-step-2-resampling" class="nav-link" data-scroll-target="#step-2-resampling">Step 2: Resampling</a></li>
  <li><a href="#step-3-zonal-statistics" id="toc-step-3-zonal-statistics" class="nav-link" data-scroll-target="#step-3-zonal-statistics">Step 3: Zonal Statistics</a></li>
  <li><a href="#step-4-terrain" id="toc-step-4-terrain" class="nav-link" data-scroll-target="#step-4-terrain">Step 4: Terrain</a></li>
  </ul></li>
  <li><a href="#rest-of-japan" id="toc-rest-of-japan" class="nav-link" data-scroll-target="#rest-of-japan">Rest of Japan</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Workshop 03: Processing and Analyzing Raster Data</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jude Bayham </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<!-- ![](banner.png){width="100%"} -->
<p>The objective of this workshop is to demonstrate how to process multiple raster layers. We will work with digital elevation model (DEM) data and continue using land cover data in Japan. Then we will use very efficient raster operations to process and summarize the data.</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<section id="reading" class="level3">
<h3 class="anchored" data-anchor-id="reading">Reading</h3>
<p><a href="https://tmieno2.github.io/R-as-GIS-for-Economists-Quarto/">R as GIS for Economists</a> remains a useful reference.</p>
</section>
<section id="digital-elevation-model-dem" class="level3">
<h3 class="anchored" data-anchor-id="digital-elevation-model-dem">Digital Elevation Model (DEM)</h3>
<p>We will use a digital elevation model (DEM) based on imagery taken by the <a href="https://portal.opentopography.org/raster?opentopoID=OTSRTM.042013.4326.1">Shuttle Radar Topography Mission (SRTM GL3) Global 90m</a> and accessed via the R package <code>elevatr</code> and OpenTopography API. Note that the data is also available in 30 meter resolution. DEMs are useful in environmental research and are the basis for other topographic calculations. OpenTopography API requires researchers to register for an API key. You may register and run the code <a href="https://github.com/jbayham/ncu_workshop/blob/b9e580060a1fa2c546bbc87c7021caaaf851ea22/docs/workshop_03/get_elevation.R">here</a>. Please download the data I have posted here:</p>
<ul>
<li><p><a href="https://colostate-my.sharepoint.com/:f:/g/personal/jbayham_colostate_edu/EtmtFq2AehFPtO0cD0Dac3kBkL27Fk9EkDtf3AGUNuOoRw?e=fChpiy">Japan DEM (by prefecture)</a> (only need Aichi for the workshop)</p></li>
<li><p><a href="https://colostate-my.sharepoint.com/:i:/r/personal/jbayham_colostate_edu/Documents/data_storage/_share/ncu_workshop/jp_dem.tif?csf=1&amp;web=1&amp;e=yNvagt">Japan DEM (merged)</a> (Optional)</p></li>
</ul>
</section>
<section id="rstudio" class="level3">
<h3 class="anchored" data-anchor-id="rstudio">RStudio</h3>
<p>We will be working with packages designed to process and visualize geospatial data. You can install a package by typing the following into the console: <code>install.packages("package_name")</code>. <em>Note the quotations</em>. Please install the following packages on the computer you will be using:</p>
<ul>
<li><code>sf</code>: simple features a package with many utilities for working with spatial vector data</li>
<li><code>terra</code>: another package for working with raster data</li>
</ul>
<p><em>Note that you do not need to install packages if they are already installed - you only need to install packages once.</em></p>
</section>
</section>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting started</h2>
<p>Before opening Rstudio and working with the data, you should organize your digital workspace.</p>
<ol type="1">
<li><p>Create a directory for this workshop titled: <code>workshop_03</code>. If you already have a directory for this class/seminar, create the directory under the class directory.</p></li>
<li><p>Create a directory titled <code>inputs</code> under <code>workshop_03</code>. The path should be <code>workshop_03/inputs</code>.</p></li>
<li><p>Download and move the [DEM] files into <code>workshop_03/inputs</code>.</p></li>
<li><p>We will also continue using the land cover data from workshop 02. Copy the file JAXA_HRLULC_Japan_v23.12_250m.tif (2022) into <code>workshop_03/inputs</code>.</p></li>
</ol>
<!-- We are also going to use the Japan political boundaries file from last week. Locate that file and copy it into `workshop_02/inputs`. -->
<p>Open up Rstudio and do the following:</p>
<ol type="1">
<li><p>Open a new script.</p></li>
<li><p>Write a comment with a brief description about what the script does. In most cases, you know the intention of the script.</p></li>
<li><p>Load the package <code>pacman</code> and use <code>p_load()</code> to install and load the packages we will be using in this workshop.</p></li>
<li><p>Navigate to <code>workshop_03</code> (the directory you just created for the project). You can use the dropdown menu Session &gt; Set Working Directory &gt; Choose Directory or type the <code>setwd("path_here")</code> command at the top of your script. If you use the dropdown menu, R will generate the <code>setwd()</code> command and display it in the console. Copy and paste it into your script.</p></li>
<li><p>Save your script and title the file: <code>workshop_03.R</code></p></li>
</ol>
<p>The first several lines of your script should look something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#This is an introduction to working with spatial data in R</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pacman) <span class="co">#if you have never used this package, you need to install it: install.packages("pacman)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse,terra)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"your_path/workshop_03"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="do">######################</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="raster-aggregation-and-zonal-statistics" class="level2">
<h2 class="anchored" data-anchor-id="raster-aggregation-and-zonal-statistics">Raster Aggregation and Zonal Statistics</h2>
<p>We will start by reading in the DEM and land cover raster layers. Our objective is to summarize the DEM information based on the land cover classification. We will illustrate the methods using only the data from Aichi, but the steps apply to all layers.</p>
<section id="step-1-loading-and-preparing-raster-data" class="level3">
<h3 class="anchored" data-anchor-id="step-1-loading-and-preparing-raster-data">Step 1: Loading and Preparing Raster Data</h3>
<p>We begin by connecting to each raster dataset using <code>terra::rast()</code>. Note that we immediately crop our land cover layer to the extent of <code>aichi_dem</code>. Notice that the resolution is different.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>aichi_dem <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"inputs/jp_dem/aichi_ken.tif"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aichi_dem)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 1040, 1424, 1  (nrow, ncol, nlyr)
resolution  : 0.0008333333, 0.0008333333  (x, y)
extent      : 136.6604, 137.8471, 34.56875, 35.43542  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source      : aichi_ken.tif 
name        : aichi_ken 
min value   :       -29 
max value   :      2015 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in land cover raster data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>aichi_lc <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="st">"inputs/JAXA_HRLULC_Japan_v23.12_250m.tif"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">crop</span>(aichi_dem) <span class="co">#crop to dem extent</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aichi_lc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 416, 570, 1  (nrow, ncol, nlyr)
resolution  : 0.002083333, 0.002083333  (x, y)
extent      : 136.6604, 137.8479, 34.56875, 35.43542  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source(s)   : memory
color table : 1 
varname     : JAXA_HRLULC_Japan_v23.12_250m 
name        : JAXA_HRLULC_Japan_v23.12_250m 
min value   :                             1 
max value   :                            14 </code></pre>
</div>
</div>
<p>We can also plot the data to see that it generally matches our expecations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot DEM</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aichi_dem)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot land cover </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aichi_lc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><code>aichi_dem</code> has missing data places covered by water and urban areas. We can confirm this by counting the number of cells with missing values <code>sum(is.na(values(aichi_dem)))</code> and calculating the fraction of the raster covered by NAs <code>sum(is.na(values(aichi_dem)))/ncell(aichi_dem)</code>.</p>
</section>
<section id="step-2-resampling" class="level3">
<h3 class="anchored" data-anchor-id="step-2-resampling">Step 2: Resampling</h3>
<p>We want to summarize data in one layer based on the other. However, the DEM is 90-meter resolution and the land cover is 250-meter resolution. As researchers, we are generally limited by the lowest-resolution data. In this case, the land cover data is 250-meter (higher resolution data is available). The function <code>terra::resample()</code> efficiently resamples the higher-resolution data to match the lower-resolution data. Print the metadata describing the layer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample elevation data to 250m to match land cover resolution</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>aichi_dem_resampled <span class="ot">&lt;-</span> <span class="fu">resample</span>(<span class="at">x =</span> aichi_dem, <span class="co">#to be resampled</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">y =</span> aichi_lc, <span class="co">#resampled to</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">method =</span> <span class="st">"bilinear"</span>) <span class="co"># Bilinear for continuous data</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Print the metadata</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aichi_dem_resampled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 416, 570, 1  (nrow, ncol, nlyr)
resolution  : 0.002083333, 0.002083333  (x, y)
extent      : 136.6604, 137.8479, 34.56875, 35.43542  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source(s)   : memory
varname     : JAXA_HRLULC_Japan_v23.12_250m 
name        :  aichi_ken 
min value   :  -11.90679 
max value   : 1954.90356 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Formally compare the layers</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">compareGeom</span>(aichi_dem_resampled, aichi_lc, <span class="at">stopOnError =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="step-3-zonal-statistics" class="level3">
<h3 class="anchored" data-anchor-id="step-3-zonal-statistics">Step 3: Zonal Statistics</h3>
<p>Now that we know the layers are aligned, we can use the function <code>terra::zonal()</code> to calculate statistics of one layer based on the other. The function name refers to the notion that the values of one layer define the <em>zone</em>. In this case, the 14 land cover classifications define the zones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate elevation statistics by land cover class</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>aichi_stats <span class="ot">&lt;-</span> <span class="fu">zonal</span>(<span class="at">x =</span> aichi_dem_resampled, <span class="co">#the layer to ve calculated</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">z =</span> aichi_lc, <span class="co">#the layer defining the zones</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fun =</span> <span class="st">"mean"</span>, <span class="co">#calculate the mean</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">na.rm=</span><span class="cn">TRUE</span>, <span class="co">#ignore NAs</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">as.raster =</span> <span class="cn">FALSE</span>) <span class="co">#output into a dataframe instead of raster - this is the default</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the columns</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>aichi_stats <span class="ot">&lt;-</span> aichi_stats <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">land_class =</span> JAXA_HRLULC_Japan_v23<span class="fl">.12</span>_250m,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">elevation =</span> aichi_ken)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aichi_stats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   land_class  elevation
1           1   88.19353
2           2   43.91542
3           3   57.67082
4           4   58.20422
5           5  205.25673
6           6  534.82683
7           7 1210.13576
8           8  199.01964
9           9  533.93950
10         10  106.97734
11         11  169.36604
12         12   78.55032
13         13  179.06948
14         14   41.57757</code></pre>
</div>
</div>
</section>
<section id="step-4-terrain" class="level3">
<h3 class="anchored" data-anchor-id="step-4-terrain">Step 4: Terrain</h3>
<p>Digital Elevation Models are useful beyond extracting elevation. One can calculate topographic information from elevation, including slope, aspect, ruggedness, among others. <code>terra::terrain()</code> can calculate these measurements by cell using information around the cell. Note that there is an identically named function in the <code>raster</code> package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate terrain</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>aichi_dem_ter <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">terrain</span>(<span class="at">x =</span> aichi_dem,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">v =</span> <span class="fu">c</span>(<span class="st">"slope"</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">neighbors =</span> <span class="dv">8</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aichi_dem_ter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 1040, 1424, 1  (nrow, ncol, nlyr)
resolution  : 0.0008333333, 0.0008333333  (x, y)
extent      : 136.6604, 137.8471, 34.56875, 35.43542  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source(s)   : memory
varname     : aichi_ken 
name        :    slope 
min value   :  0.00000 
max value   : 50.97108 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the slope data</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aichi_dem_ter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As you might expect, the mountainous areas have the steepest slopes. Let’s calculate slope, aspect, and ruggedness (see the <code>terrain()</code> documentation for calculation details).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate terrain</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>aichi_dem_ter <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">terrain</span>(aichi_dem,<span class="at">v=</span><span class="fu">c</span>(<span class="st">"slope"</span>,<span class="st">"aspect"</span>,<span class="st">"TRI"</span>),<span class="at">neighbors=</span><span class="dv">8</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aichi_dem_ter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 1040, 1424, 3  (nrow, ncol, nlyr)
resolution  : 0.0008333333, 0.0008333333  (x, y)
extent      : 136.6604, 137.8471, 34.56875, 35.43542  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source(s)   : memory
names       :    slope, aspect,    TRI 
min values  :  0.00000,      0,  0.000 
max values  : 50.97108,    360, 76.125 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the slope data</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aichi_dem_ter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we can use zonal to calculate the mean of these metrics by land classification. Remember to resample up to 250-meter resolution first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#reample to 250 meter</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>aichi_dem_ter_resampled <span class="ot">&lt;-</span> <span class="fu">resample</span>(aichi_dem_ter, aichi_lc, <span class="at">method =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate slope on land classes</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>aichi_ter_stats <span class="ot">&lt;-</span> <span class="fu">zonal</span>(aichi_dem_ter_resampled, aichi_lc, <span class="at">fun =</span> <span class="st">"mean"</span>,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aichi_ter_stats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   JAXA_HRLULC_Japan_v23.12_250m     slope   aspect       TRI
1                              1  5.944707 182.8890  8.241594
2                              2  2.156068 188.1572  3.202888
3                              3  2.164119 184.5863  3.321029
4                              4  2.855291 185.4829  4.103046
5                              5  5.538700 187.1487  7.676857
6                              6 13.576250 188.2740 18.385386
7                              7 15.757645 173.0469 20.809032
8                              8 13.221970 182.3056 17.857486
9                              9 15.062418 186.4063 20.251659
10                            10  5.501523 187.1796  7.880273
11                            11  8.202447 186.7086 11.269355
12                            12  3.690616 183.2676  5.255811
13                            13  5.474092 185.8851  7.824027
14                            14  2.186525 186.0377  3.175129</code></pre>
</div>
</div>
<section id="hillshade" class="level4">
<h4 class="anchored" data-anchor-id="hillshade">Hillshade</h4>
<p>You may also want to use the DEM as a baselayer on another map. You can use <code>terra::shade()</code> to compute a layer to be plotted as a basemap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Recreate the slope and aspect components in radians</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>aichi_ter_rad <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">terrain</span>(aichi_dem,<span class="at">v=</span><span class="fu">c</span>(<span class="st">"slope"</span>,<span class="st">"aspect"</span>),<span class="at">unit=</span><span class="st">"radians"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Construct shade raster</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>hill <span class="ot">&lt;-</span> <span class="fu">shade</span>(aichi_ter_rad<span class="sc">$</span>slope, </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>              aichi_ter_rad<span class="sc">$</span>aspect, </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>              <span class="dv">40</span>, <span class="dv">270</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot it with a gray color scheme</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hill, <span class="at">col=</span><span class="fu">grey</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">100</span><span class="sc">/</span><span class="dv">100</span>), <span class="at">legend=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="rest-of-japan" class="level2">
<h2 class="anchored" data-anchor-id="rest-of-japan">Rest of Japan</h2>
<p>We have illustrated how to resample and summarize data in one layer based on another in Aichi. Given the DEMs for the other prefectures, how could you compute these statistics for all of Japan?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Download the merged or stitched layer</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>jp_dem <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"inputs/jp_dem.tif"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in land cover raster data</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>jp_lc <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="st">"inputs/JAXA_HRLULC_Japan_v23.12_250m.tif"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">crop</span>(jp_dem)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample elevation data to 250m to match land cover resolution</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>jp_dem_resampled <span class="ot">&lt;-</span> <span class="fu">resample</span>(<span class="at">x =</span> jp_dem, <span class="co">#to be resampled</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                                <span class="at">y =</span> jp_lc, <span class="co">#resampled to</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                                <span class="at">method =</span> <span class="st">"bilinear"</span>) </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>jp_stats <span class="ot">&lt;-</span> <span class="fu">zonal</span>(<span class="at">x =</span> jp_dem_resampled, <span class="co">#the layer to ve calculated</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">z =</span> jp_lc, <span class="co">#the layer defining the zones</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fun =</span> <span class="st">"mean"</span>, <span class="co">#calculate the mean</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">na.rm=</span><span class="cn">TRUE</span>, <span class="co">#ignore NAs</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">as.raster =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>These three workshops covered how to work with spatial data. Specifically, the workshop demonstrates how to process vector and raster data, and any combination of the two. The following briefly summarizes the material in each workshop.</p>
<p>Workshop 01</p>
<ul>
<li>Merging non-spatial data with spatial data to create thematic maps (choropleth)</li>
<li>Coordinate Reference Systems and transformation</li>
<li>Using <code>tmap</code> to visualize data</li>
</ul>
<p>Workshop 02</p>
<ul>
<li>Extracting raster values based on polygon boundaries</li>
<li>Creating a buffer around a point of interest</li>
<li>Reassigning color palette for better map making</li>
<li>FE regression</li>
<li>Visualizing data over time</li>
</ul>
<p>Workshop 03</p>
<ul>
<li>Resampling raster data to match lower-resolution data</li>
<li>Summarizing data in one layer based on categorical data in another layer</li>
<li>Use terrain function to calculate slope and more from digital elevation model</li>
</ul>
<hr>
<p>Workshop website and code available <a href="https://github.com/jbayham/ncu_workshop/tree/b9e580060a1fa2c546bbc87c7021caaaf851ea22/docs/workshop_03">here</a>.</p>
<p><a href="https://jbayham.github.io/ncu_workshop/">Workshop Home Page</a></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>